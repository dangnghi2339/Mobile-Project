package com.example.lab2;

import android.os.Bundle;

import androidx.activity.EdgeToEdge;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.Insets;
import androidx.core.view.ViewCompat;
import androidx.core.view.WindowInsetsCompat;

import android.os.CountDownTimer;
import android.os.Handler;
import android.os.Looper;
import android.view.View;
import android.widget.*;

import java.util.Random;

public class MainActivity extends AppCompatActivity {


    private TextView txt_Time;
    private TextView txt_Num1;
    private TextView txt_Num2;
    private TextView txt_Result;
    private Button btn_false;
    private Button btn_true;
    private TextView txt_Status;

    private CountDownTimer countDownTimer;
    private int score = 0;
    private boolean isCorrectAnswer; // Biến để lưu câu trả lời đúng của phép tính hiện tại
    private final Random random = new Random();
    private final Handler handler = new Handler(Looper.getMainLooper());
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        EdgeToEdge.enable(this);
        setContentView(R.layout.activity_main);
        txt_Time = (TextView) findViewById(R.id.txt_Time);
        txt_Num1 = (TextView) findViewById(R.id.txt_Num1);
        txt_Num2 = (TextView) findViewById(R.id.txt_Num2);
        txt_Result = (TextView) findViewById(R.id.txt_Result);
        btn_false = (Button) findViewById(R.id.btn_false);
        btn_true = (Button) findViewById(R.id.btn_true);
        txt_Status = (TextView) findViewById(R.id.txt_Status);

        btn_true.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                checkAnswer(true);
            }
        });
        btn_false.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                checkAnswer(false);
            }
        });

        startNewRound();
        }
    private void generateQuestion() {
        // Tạo 2 số ngẫu nhiên từ 0 đến 99
        int num1 = random.nextInt(50);
        int num2 = random.nextInt(50);
        int realSum = num1 + num2;

        // 50% cơ hội hiển thị kết quả đúng hoặc sai
        if (random.nextBoolean()) {
            // Hiển thị kết quả đúng
            txt_Result.setText("= " + realSum);
            isCorrectAnswer = true;
        } else {
            // Hiển thị kết quả sai (cộng/trừ một số ngẫu nhiên)
            int fakeSum = realSum + random.nextInt(10) - 5;
            // Đảm bảo kết quả sai không vô tình trùng với kết quả đúng
            if (fakeSum == realSum) {
                fakeSum++;
            }
            txt_Result.setText("= " + fakeSum);
            isCorrectAnswer = false;
        }

        // Cập nhật giao diện
        txt_Num1.setText(String.valueOf(num1));
        txt_Num2.setText(String.valueOf(num2));
    }
    private void startTimer() {
        // Hủy bộ đếm cũ nếu đang chạy
        if (countDownTimer != null) {
            countDownTimer.cancel();
        }

        // Tạo bộ đếm mới: 2 giây, cập nhật mỗi giây
        countDownTimer = new CountDownTimer(10000, 1000) {
            @Override
            public void onTick(long millisUntilFinished) {
                // Cập nhật thời gian còn lại
                txt_Time.setText("Time: " + millisUntilFinished / 1000);
            }

            @Override
            public void onFinish() {
                // Khi hết giờ, người chơi thua
                gameOver("Lose");
            }
        }.start();
    }
    private void startNewRound() {
        txt_Status.setVisibility(View.INVISIBLE); // Ẩn thông báo trạng thái
        btn_true.setEnabled(true); // Bật lại các nút
        btn_false.setEnabled(true);
        score = 0; // Reset điểm
        generateQuestion();
        startTimer();
    }


    // Hàm kiểm tra câu trả lời của người dùng
    private void checkAnswer(boolean userAnswer) {
        countDownTimer.cancel(); // Dừng bộ đếm thời gian

        // Nếu câu trả lời của người dùng khớp với đáp án đúng
        if (userAnswer == isCorrectAnswer) {
            score++; // Tăng điểm
            // Nếu đủ 10 điểm thì thắng
            if (score >= 10) {
                gameOver("Win");
            } else {
                // Nếu chưa đủ điểm, tạo câu hỏi mới
                generateQuestion();
                startTimer();
            }
        } else {
            // Nếu trả lời sai, người chơi thua
            gameOver("Fail");
        }
    }
    private void gameOver(String status) {
        txt_Status.setText(status);
        txt_Status.setVisibility(View.VISIBLE);

        // Vô hiệu hóa tạm thời các nút để người dùng không click trong lúc chờ
        btn_true.setEnabled(false);
        btn_false.setEnabled(false);

        // SỬA ĐỔI LỚN NHẤT NẰM Ở ĐÂY:
        // Sử dụng Handler để gọi startNewRound sau 2000ms (2 giây)
        handler.postDelayed(new Runnable() {
            @Override
            public void run() {
                startNewRound();
            }
        }, 2000);
    }

}